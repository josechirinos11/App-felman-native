router.get('/tiempos-operario-lote', async (req, res) => {
  const { num_manual } = req.query;
  if (!num_manual) {
    return res.status(400).json({ status: 'error', message: 'Falta num_manual' });
  }

  const sql = `
    SELECT
      OperarioNombre,
      CodigoOperario,
      COALESCE(CodigoTarea,'(SIN TAREA)') AS Tarea,
      SUM(COALESCE(TiempoDedicado,0))    AS SegundosDedicados,
      SEC_TO_TIME(SUM(COALESCE(TiempoDedicado,0))) AS HH_MM_SS
    FROM vpartestodo
    WHERE CodigoLote = (SELECT Codigo FROM lotes WHERE NumeroManual = ?)
    GROUP BY OperarioNombre, CodigoOperario, CodigoTarea
    ORDER BY OperarioNombre, Tarea
  `;

  try {
    const [rows] = await pool.execute(sql, [num_manual]);
    res.status(200).json(rows);
  } catch (error) {
    console.error('‚ùå ERROR EN /control-terminales/tiempos-por-operario:', error);
    res.status(500).json({ status: 'error', message: error.message });
  }
});